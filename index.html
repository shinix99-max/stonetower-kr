<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë§ˆìŒ ìŒ“ê¸° - ë””ì§€í„¸ ëŒíƒ‘</title>
    <script src="https://cdn.jsdelivr.net/npm/poly-decomp@0.3.0/dist/poly-decomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { --primary: #4a69bd; --bg: #0a0a0a; --text: #f0f2f5; }
        body { margin: 0; padding: 0; overflow: hidden; background: var(--bg); font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; touch-action: none; }
        
        #game-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 500px; 
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100); /* ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ê³„ì‚°ëœ ë†’ì´ ì‚¬ìš© */
            background: #0a0a0a; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        /* PC ë²„ì „ ì „ìš© ìŠ¤íƒ€ì¼ */
        @media (min-width: 501px) {
            #game-wrapper {
                height: 90vh;
                height: 90dvh;
                border-radius: 30px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            }
        }
        
        /* ë°°ê²½ ë ˆì´ì–´ */
        #bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: background-image 1.5s ease-in-out;
            z-index: 1;
            opacity: 0.35; /* ë” ì–´ë‘¡ê²Œ ì¡°ì • */
        }

        .page { position: absolute; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; z-index: 10; color: white; text-align: center; }
        .page.active { display: flex; }

        /* ëœë”© í˜ì´ì§€ */
        #landing-page { 
            background: linear-gradient(to bottom, #1a1a1a, #0a0a0a); 
            z-index: 60; 
        }
        .logo { font-size: 42px; font-weight: 900; margin-bottom: 10px; color: #f5f5f5; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .sub-logo { font-size: 16px; color: #ccc; margin-bottom: 40px; }
        .input-group { width: 80%; display: flex; flex-direction: column; gap: 15px; }
        input#nickname { padding: 18px; border-radius: 15px; border: 2px solid #333; background: #1a1a1a; color: white; font-size: 18px; text-align: center; outline: none; }
        .start-btn { background: var(--primary); color: white; padding: 18px; border-radius: 15px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; }

        /* ê²Œì„ í˜ì´ì§€ */
        #game-page { padding: 0; cursor: default; background: transparent; overflow: hidden; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        
        #wish-btn { 
            position: absolute; top: 30px; right: 30px; 
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 10px 20px; border-radius: 25px; 
            font-weight: bold; cursor: pointer; z-index: 30;
            backdrop-filter: blur(5px);
        }
        #wish-btn:hover { background: var(--primary); }

        #info { position: absolute; top: 30px; left: 30px; pointer-events: none; z-index: 20; text-align: left; }
        .stats { font-size: 20px; font-weight: 800; color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.7); }
        .guide-text { 
            position: absolute; 
            bottom: 50px; /* íšŒìƒ‰ ë°•ìŠ¤ ì•ˆìª½ìœ¼ë¡œ ì´ë™ */
            width: 100%; 
            text-align: center; 
            color: rgba(255,255,255,0.8); 
            font-size: 15px; 
            font-weight: 500; 
            pointer-events: none; 
            z-index: 20; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.4); 
        }

        /* ì†Œì› ì…ë ¥ í˜ì´ì§€ */
        #wish-page { background: rgba(10, 10, 10, 0.9); z-index: 70; }
        #wish-page h2 { font-size: 28px; margin-bottom: 20px; }
        textarea#wish-text { width: 90%; height: 180px; padding: 20px; border-radius: 20px; border: 2px solid #333; background: #1a1a1a; color: white; margin-bottom: 30px; resize: none; font-size: 18px; outline: none; box-sizing: border-box; }
        .submit-wish-btn { background: var(--primary); color: white; padding: 18px 40px; border-radius: 15px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; width: 90%; }

        /* ê²°ê³¼ í˜ì´ì§€ (ëŒ€ì‹œë³´ë“œ) */
        #result-page { background: #0a0a0a; overflow-y: auto; justify-content: flex-start; padding-top: 40px; padding-bottom: 40px; }
        .screenshot-container { 
            width: 90%; 
            height: 40vh; 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            margin-bottom: 20px; 
            border: 1px solid #333; 
            background: #1a1a1a;
        }
        #final-screenshot { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            object-position: bottom; 
            display: block; 
        }
        .cheer-msg { font-size: 20px; font-weight: 700; margin-bottom: 30px; color: #ddd; }
        
        .leaderboard { 
            width: 80%; 
            height: 40vh; 
            background: #1a1a1a; 
            border-radius: 20px; 
            padding: 20px; 
            margin-bottom: 40px; 
            border: 1px solid #333; 
            overflow-y: auto;
            box-sizing: border-box;
        }
        .leaderboard h3 { margin-top: 0; font-size: 18px; color: #aaa; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .rank-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 16px; }
        .rank-item:last-child { border-bottom: none; }
        .rank-name { color: #f5f5f5; }
        .rank-score { color: var(--primary); font-weight: bold; }

        .share-group { display: flex; gap: 20px; margin-top: 10px; }
        .share-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #222; cursor: pointer; font-size: 20px; border: 1px solid #333; transition: 0.2s; }
        .share-btn:hover { transform: translateY(-5px); background: #333; }

        /* ì‹œì‘ ì˜¤ë²„ë ˆì´ */
        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            z-index: 25;
            cursor: pointer;
        }
        .start-text {
            font-size: 32px;
            font-weight: bold;
            color: white;
            animation: pulse 2s infinite;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="bg-layer"></div>

    <section id="landing-page" class="page active">
        <h1 class="logo">ë§ˆìŒ ìŒ“ê¸°</h1>
        <p class="sub-logo">ë‹¹ì‹ ì˜ ì†Œì›ì„ ëŒíƒ‘ì— ë‹´ì•„ë³´ì„¸ìš”.</p>
        <div class="input-group">
            <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            <button class="start-btn" onclick="goToGame()">ì‹œì‘í•˜ê¸°</button>
        </div>
    </section>

    <section id="game-page" class="page">
        <button id="wish-btn" onclick="goToWish()">ì†Œì› ë¹Œê¸°</button>
        <div id="info">
            <div class="stats"><span id="user-nickname-display">ìœ ì €</span>ë‹˜ì˜ ëŒíƒ‘</div>
            <div class="stats"><span id="count">1</span>ì¸µ</div>
        </div>
        <div id="start-overlay" onclick="startGame(event)" style="cursor: pointer; pointer-events: auto;">
            <div class="start-text" style="pointer-events: none;">í„°ì¹˜í•˜ì—¬ ì‹œì‘</div>
            <p style="font-size: 14px; color: #aaa; margin-top: 20px; pointer-events: none;">* ì†Œì› ë¹Œê¸°ë¥¼ ëˆ„ë¥´ë©´ ë‹¤ì‹œ ìŒ“ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <div id="canvas-container"></div>
        <div class="guide-text">ì›í•˜ëŠ” ìœ„ì¹˜ë¡œ ëŒì–´ì„œ ë†“ìœ¼ì„¸ìš”.</div>
    </section>

    <section id="wish-page" class="page">
        <h2>ì†Œì› ì ê¸°</h2>
        <p style="color: #aaa; margin-bottom: 20px;">ì´ íƒ‘ì— ë‹´ì„ ì†Œì¤‘í•œ ë§ˆìŒì„ ì ì–´ì£¼ì„¸ìš”.</p>
        <textarea id="wish-text" placeholder="ì—¬ê¸°ì— ì†Œì›ì„ ì ì–´ì£¼ì„¸ìš”..."></textarea>
        <button class="submit-wish-btn" onclick="finishGame()">ì†Œì› ì €ì¥í•˜ê³  ê²°ê³¼ ë³´ê¸°</button>
    </section>

    <section id="result-page" class="page">
        <div class="screenshot-container" id="screenshot-area">
            <img id="final-screenshot" src="" alt="ë‚˜ì˜ ëŒíƒ‘">
        </div>
        <p class="cheer-msg">ë‹¹ì‹ ì˜ ì†Œì›ì´<br>ê¼­ ì´ë£¨ì–´ì§€ê¸¸ ë°”ëë‹ˆëŒ.<br><br><span style="font-size: 16px; opacity: 0.8;">- ëŒë©©ì´ ì¼ë™ -</span></p>
        
        <div class="leaderboard">
            <h3>ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ë§ˆìŒ</h3>
            <div id="leaderboard-list">
                <!-- ìˆœìœ„í‘œ ì•„ì´í…œ ì‚½ì…ë¨ -->
            </div>
        </div>

        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">ê³µìœ í•˜ê¸°</p>
        <div class="share-group">
            <div class="share-btn" onclick="alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  (êµ¬í˜„ ì˜ˆì •)')">ğŸ’¬</div>
            <div class="share-btn" onclick="alert('ì¸ìŠ¤íƒ€ê·¸ë¨ ê³µìœ  (êµ¬í˜„ ì˜ˆì •)')">ğŸ“¸</div>
            <div class="share-btn" onclick="alert('íŠ¸ìœ„í„° ê³µìœ  (êµ¬í˜„ ì˜ˆì •)')">ğŸ¦</div>
        </div>
        
        <button class="retry-btn" style="margin-top: 40px; background: none; color: #666; border: none; text-decoration: underline;" onclick="location.reload()">ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</button>
    </section>
</div>

<script>
    // â–¼â–¼â–¼ ì´ë¯¸ì§€ ê²½ë¡œ í™•ì¸ â–¼â–¼â–¼
    const BG_IMAGES = {
        level1: 'url("./low_background_3.png")', 
        level2: 'url("./middle_background_3.png")', 
        level3: 'url("./high_background_3.png")'   
    };

    // ëŒ ëª¨ì–‘ í…œí”Œë¦¿ (ìœ—ë©´ê³¼ ì•„ë«ë©´ì„ ë” í‰í‰í•˜ê²Œ ê°œì„ í•˜ì—¬ ì•ˆì •ê° ê°•í™”)
    const SHAPE_TEMPLATES = [
        // 1. í‰í‰í•œ ë„“ì ëŒ (ëŒ€ì¹­)
        [
            {x: -0.55, y: 0}, {x: -0.5, y: -0.15}, {x: -0.3, y: -0.22}, {x: 0, y: -0.25}, {x: 0.3, y: -0.22},
            {x: 0.5, y: -0.15}, {x: 0.55, y: 0}, {x: 0.5, y: 0.15}, {x: 0.3, y: 0.22}, {x: 0, y: 0.25},
            {x: -0.3, y: 0.22}, {x: -0.5, y: 0.15}, {x: -0.55, y: 0.05}, {x: -0.54, y: -0.05}
        ],
        // 2. ë¹„ëŒ€ì¹­ í‰í‰ì´ 1
        [
            {x: -0.45, y: 0}, {x: -0.4, y: -0.18}, {x: -0.1, y: -0.25}, {x: 0.2, y: -0.24}, {x: 0.5, y: -0.15},
            {x: 0.55, y: 0.05}, {x: 0.45, y: 0.2}, {x: 0.1, y: 0.25}, {x: -0.2, y: 0.23}, {x: -0.4, y: 0.15}
        ],
        // 3. ë‘¥ê¸€ì§€ë§Œ ë°”ë‹¥ì€ í‰í‰í•œ ëŒ
        [
            {x: -0.4, y: 0.05}, {x: -0.35, y: -0.15}, {x: -0.15, y: -0.23}, {x: 0.15, y: -0.23}, {x: 0.35, y: -0.15},
            {x: 0.4, y: 0.05}, {x: 0.35, y: 0.22}, {x: 0.1, y: 0.25}, {x: -0.1, y: 0.25}, {x: -0.35, y: 0.22}
        ],
        // 4. ë¹„ëŒ€ì¹­ í‰í‰ì´ 2
        [
            {x: -0.5, y: 0.05}, {x: -0.45, y: -0.12}, {x: -0.1, y: -0.25}, {x: 0.3, y: -0.22}, {x: 0.52, y: -0.05},
            {x: 0.48, y: 0.18}, {x: 0.2, y: 0.25}, {x: -0.15, y: 0.24}, {x: -0.4, y: 0.18}
        ],
        // 5. ì§ì‚¬ê°í˜•ì— ê°€ê¹Œìš´ ìì—°ì„
        [
            {x: -0.58, y: -0.05}, {x: -0.5, y: -0.22}, {x: 0, y: -0.25}, {x: 0.5, y: -0.22}, {x: 0.58, y: -0.05},
            {x: 0.55, y: 0.18}, {x: 0, y: 0.25}, {x: -0.55, y: 0.18}
        ]
    ];

    let nickname = "";
    let stoneCount = 0;
    let isGameOver = false;
    let isGameStarted = false;
    let stones = [];
    let isPressing = false;
    let isValidLocation = true;    
    let initialTouchX = 0; 
    let initialTouchY = 0; // [ì¶”ê°€] í„°ì¹˜ ì‹œì‘ Y ìœ„ì¹˜
    let initialStoneX = 0; 
    let initialStoneY = 0; // [ì¶”ê°€] í„°ì¹˜ ì‹œì‘ ì‹œ ëŒì˜ Y ìœ„ì¹˜
    
    // [ì¤‘ìš”] ì¹´ë©”ë¼ ì¢Œí‘œ ì œì–´ ë³€ìˆ˜
    let cameraY = 0;        // í˜„ì¬ ì¹´ë©”ë¼ ë†’ì´
    let targetCameraY = 0;  // ëª©í‘œ ì¹´ë©”ë¼ ë†’ì´

    const { Engine, Render, Runner, Bodies, Composite, Body, Events, Bounds } = Matter;
    let engine, render, runner, ground, baseStone;
    
    let nextStoneData = { w: 0, h: 0 }; 
    let currentInputPos = { x: 225, y: 200 };
    let gameWidth = 450;
    let gameHeight = 800;

    window.onload = () => {
            // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ë†’ì´ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ í•¨ìˆ˜ í˜¸ì¶œ
            resetScreenHeight();
            window.addEventListener('resize', resetScreenHeight);

            // poly-decomp ë¼ì´ë¸ŒëŸ¬ë¦¬ ë“±ë¡ ë°©ì‹ì„ ë” í™•ì‹¤í•˜ê²Œ ë³´ê°•
            const decompLib = window.decomp || (typeof decomp !== 'undefined' ? decomp : null);
            if (decompLib) {
                Matter.Common.setDecomp(decompLib);
            } else {
                console.error("poly-decomp ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            
            updateEnvironment(1);
            initPhysics();
        };

        function resetScreenHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    }

    function goToGame() {
        const input = document.getElementById('nickname');
        if (!input.value.trim()) {
            alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }
        nickname = input.value.trim();
        document.getElementById('user-nickname-display').textContent = nickname;
        showPage('game-page');
    }

    async function goToWish() {
        // [ì¶”ê°€] ëŒë“¤ì´ ëª¨ë‘ ë©ˆì¶˜(Static) ìƒíƒœì¸ì§€ í™•ì¸
        const activeStones = stones.filter(s => !s.isStatic);
        if (activeStones.length > 0) {
            alert("ëŒë“¤ì´ ì•„ì§ ì›€ì§ì´ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!");
            return;
        }

        const matterCanvas = document.querySelector('#canvas-container canvas');
        const bgLayer = document.getElementById('bg-layer');
        const finalImg = document.getElementById('final-screenshot');

        if (!matterCanvas || !bgLayer || !finalImg) {
            showPage('wish-page');
            return;
        }

        // 1. ì„ì‹œ ìº”ë²„ìŠ¤ ìƒì„± (í•©ì¹˜ê¸°ìš©)
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = matterCanvas.width;
        tempCanvas.height = matterCanvas.height;
        const ctx = tempCanvas.getContext('2d');

        // 2. í˜„ì¬ ë°°ê²½ ì´ë¯¸ì§€ URL ì¶”ì¶œ
        const bgStyle = bgLayer.style.backgroundImage;
        const bgUrl = bgStyle.replace(/url\(['"]?(.*?)['"]?\)/i, '$1');
        
        const bgImg = new Image();
        bgImg.crossOrigin = "anonymous";
        bgImg.onload = () => {
            // ë°°ê²½ ê·¸ë¦¬ê¸° (í™”ë©´ì— ê½‰ ì°¨ê²Œ)
            const canvasRatio = tempCanvas.width / tempCanvas.height;
            const imgRatio = bgImg.width / bgImg.height;
            let drawWidth, drawHeight, offsetX, offsetY;

            if (canvasRatio > imgRatio) {
                drawWidth = tempCanvas.width;
                drawHeight = tempCanvas.width / imgRatio;
                offsetX = 0;
                offsetY = (tempCanvas.height - drawHeight) / 2;
            } else {
                drawWidth = tempCanvas.height * imgRatio;
                drawHeight = tempCanvas.height;
                offsetX = (tempCanvas.width - drawWidth) / 2;
                offsetY = 0;
            }

            ctx.save();
            ctx.globalAlpha = 0.35; // ë°°ê²½ì„ ì‹¤ì œ í™”ë©´ì²˜ëŸ¼ ì–´ë‘¡ê²Œ ì²˜ë¦¬
            ctx.drawImage(bgImg, offsetX, offsetY, drawWidth, drawHeight);
            ctx.restore();
            
            // 3. ëŒíƒ‘ ìº”ë²„ìŠ¤ ìœ„ì— ë®ì–´ì“°ê¸° (ê¸°ë°˜ì„ í•˜ë‹¨ì´ ì´ë¯¸ì§€ í•˜ë‹¨ì— ì˜¤ë„ë¡ ê·¸ë¦¬ê¸°)
            const isMobile = window.innerWidth <= 500;
            const baseBottomOffset = isMobile ? 200 : 150;
            
            // ê¸°ë°˜ì„ì˜ ì¤‘ì‹¬ì´ stopY(gameHeight - baseBottomOffset)ì— ìˆê³ ,
            // ê¸°ë°˜ì„ì˜ ë†’ì´ê°€ 50pxì´ë¯€ë¡œ, ê¸°ë°˜ì„ì˜ í•˜ë‹¨ ì‹¤ì œ ì¢Œí‘œëŠ” gameHeight - baseBottomOffset + 25 ì…ë‹ˆë‹¤.
            const baseStoneBottomY = gameHeight - baseBottomOffset + 25;
            
            // ìº”ë²„ìŠ¤ì—ì„œ (0, 0)ë¶€í„° baseStoneBottomYê¹Œì§€ì˜ ì˜ì—­ì„ ìº¡ì²˜í•˜ì—¬
            // ê²°ê³¼ ì´ë¯¸ì§€ì˜ í•˜ë‹¨ì— ë§ì¶°ì„œ ê·¸ë¦½ë‹ˆë‹¤.
            const sourceHeight = baseStoneBottomY;
            const destHeight = tempCanvas.height;
            const scale = destHeight / sourceHeight;
            const destWidth = gameWidth * scale;
            const destX = (tempCanvas.width - destWidth) / 2;

            ctx.drawImage(
                matterCanvas, 
                0, 0, gameWidth, sourceHeight, // ì†ŒìŠ¤ ì˜ì—­: í™”ë©´ ìƒë‹¨ë¶€í„° ê¸°ë°˜ì„ í•˜ë‹¨ê¹Œì§€
                destX, 0, destWidth, destHeight // ëŒ€ìƒ ì˜ì—­: ê²°ê³¼ ë°•ìŠ¤ì— ê½‰ ì°¨ê²Œ (ë†’ì´ ê¸°ì¤€)
            );

            // 4. ìµœì¢… ì´ë¯¸ì§€ ê²°ê³¼ë¬¼ ìƒì„±
            finalImg.src = tempCanvas.toDataURL('image/png');
            
            // ë Œë”ë§ ì •ì§€ ë° í˜ì´ì§€ ì´ë™
            completeGoToWish();
        };
        
        bgImg.onerror = () => {
            // ë°°ê²½ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê²€ì€ ë°°ê²½ì— ëŒíƒ‘ë§Œì´ë¼ë„ ìº¡ì²˜
            ctx.fillStyle = "#0a0a0a";
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            ctx.drawImage(matterCanvas, 0, 0);
            finalImg.src = tempCanvas.toDataURL('image/png');
            completeGoToWish();
        };
        
        bgImg.src = bgUrl;
    }

    function completeGoToWish() {
        Runner.stop(runner);
        Render.stop(render);
        showPage('wish-page');
    }

    function finishGame() {
        const wishInput = document.getElementById('wish-text');
        if (!wishInput.value.trim()) {
            alert("ì†Œì›ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }
        
        // ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ ì„œë²„ì— ì €ì¥í•˜ëŠ” ë¡œì§ì´ ë“¤ì–´ê°
        renderLeaderboard();
        showPage('result-page');
    }

    function renderLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        // ê°€ìƒì˜ ìˆœìœ„í‘œ ë°ì´í„° (ì‹¤ì œ ë°±ì—”ë“œ ì—°ë™ ì „ê¹Œì§€)
        let dummyData = [
            { name: "í‰ì˜¨í•œêµ¬ë¦„", floor: 25 },
            { name: "ê¹Šì€ì‚°ì†", floor: 22 },
            { name: "ì¡°ìš©í•œê°•ë¬¼", floor: 18 },
            { name: "ìƒˆë²½ì•ˆê°œ", floor: 15 },
            { name: "ë°”ëŒê°œë¹„", floor: 12 },
            { name: "í–‡ì‚´í•œìŠ¤í‘¼", floor: 10 },
            { name: "í‘¸ë¥¸ë°”ë‹¤", floor: 8 }
        ];
        
        // ë‚´ ë°ì´í„° ì¶”ê°€
        const myScore = { name: nickname, floor: stoneCount + 1 };
        
        // ì¤‘ë³µ ì œê±° ë° ì •ë ¬
        let allData = dummyData.filter(d => d.name !== nickname);
        allData.push(myScore);
        allData.sort((a, b) => b.floor - a.floor);

        // ë‚´ ìˆœìœ„ ì°¾ê¸°
        const myRank = allData.findIndex(d => d.name === nickname) + 1;
        const top3 = allData.slice(0, 3);
        
        let html = "";
        
        // ìƒìœ„ 3ìœ„ ì¶œë ¥
        top3.forEach((item, index) => {
            const isMe = item.name === nickname;
            html += `
                <div class="rank-item" style="${isMe ? 'background: rgba(74, 105, 189, 0.2); border-radius: 10px; padding: 10px;' : ''}">
                    <span class="rank-name">${index + 1}ìœ„ / ${item.name}</span>
                    <span class="rank-score">${item.floor}ì¸µ</span>
                </div>
            `;
        });

        // ë‚´ê°€ 3ìœ„ ì•ˆì— ì—†ìœ¼ë©´ êµ¬ë¶„ì„ ê³¼ í•¨ê»˜ ë‚´ ìˆœìœ„ ì¶”ê°€
        if (myRank > 3) {
            html += `<div style="padding: 10px 0; color: #444; font-size: 12px;">â€¢â€¢â€¢â€¢â€¢</div>`;
            html += `
                <div class="rank-item" style="background: rgba(74, 105, 189, 0.2); border-radius: 10px; padding: 10px;">
                    <span class="rank-name">${myRank}ìœ„ / ${nickname}</span>
                    <span class="rank-score">${stoneCount + 1}ì¸µ</span>
                </div>
            `;
        }

        list.innerHTML = html;
    }

    function startGame(e) {
        if (e) {
            e.stopPropagation();
            e.preventDefault();
        }
        console.log("Starting Game..."); // í™•ì¸ìš© ë¡œê·¸
        if (isGameStarted) return;
        isGameStarted = true;
        
        const overlay = document.getElementById('start-overlay');
        if (overlay) {
            overlay.style.pointerEvents = 'none';
            overlay.style.display = 'none';
        }

        // ê¸°ë°˜ì•” ìƒì„± ë° ë‚™í•˜
        const baseWidth = 160;
        const baseHeight = 50;
        const targetY = gameHeight - 80; // ë°”ë‹¥ì—ì„œ ì¡°ê¸ˆ ë” ìœ„ë¡œ (ê¸°ì¡´ 50 -> 80)
        
        baseStone = Bodies.rectangle(gameWidth / 2, -50, baseWidth, baseHeight, { 
            friction: 10.0, // ë§ˆì°°ë ¥ ê·¹ëŒ€í™” (ê¸°ì¡´ 2.0)
            frictionStatic: 1000.0, // ì •ì  ë§ˆì°°ë ¥ ê·¹ëŒ€í™” (ê¸°ì¡´ 100.0)
            density: 200, 
            chamfer: { radius: 25 }, 
            label: 'baseStone',
            isStatic: false, 
            render: { fillStyle: '#dcdcdc' } 
        });
        
        stones.push(baseStone);
        Composite.add(engine.world, baseStone);
        
        // ê¸°ë°˜ì•”ì´ ì–´ëŠ ì •ë„ ë‚´ë ¤ì˜¨ í›„ ë‹¤ìŒ ëŒ ì¤€ë¹„
        setTimeout(() => {
            prepareNextStone();
        }, 1000);
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    }

    // ì¸µìˆ˜ì— ë”°ë¼ ë°°ê²½ë§Œ ë³€ê²½ (ì¹´ë©”ë¼ ì´ë™ì€ ì¼ë‹¨ ì œì™¸)
    function updateEnvironment(floor) {
        const bgLayer = document.getElementById('bg-layer');
        
        if (floor <= 5) {
            bgLayer.style.backgroundImage = BG_IMAGES.level1;
        } else if (floor <= 10) {
            bgLayer.style.backgroundImage = BG_IMAGES.level2;
        } else {
            bgLayer.style.backgroundImage = BG_IMAGES.level3;
        }
        
        targetCameraY = 0; // ì¹´ë©”ë¼ë¥¼ ìœ„ë¡œ ì˜¬ë¦¬ì§€ ì•Šê³  ê³ ì •
    }

    function prepareNextStone() {
        const w = 110 + Math.random() * 40; 
        const h = w * 0.6; 
        
        // ëœë¤ í…œí”Œë¦¿ ì„ íƒ ë° ìŠ¤ì¼€ì¼ë§
        const template = SHAPE_TEMPLATES[Math.floor(Math.random() * SHAPE_TEMPLATES.length)];
        const scaledVertices = template.map(v => ({ x: v.x * w, y: v.y * h }));
        
        nextStoneData = { w: w, h: h, vertices: scaledVertices };
        // [ìˆ˜ì •] ëŒ ìƒì„± ìœ„ì¹˜ë¥¼ ì¡°ê¸ˆ ë” ë‚®ì¶¤ (250 -> 320)
        currentInputPos = { x: gameWidth / 2, y: 320 + targetCameraY }; 
    }

    function initPhysics() {
        const container = document.getElementById('canvas-container');
        const isMobile = window.innerWidth <= 500;
        
        // [ìˆ˜ì •] ìˆ¨ê²¨ì§„ ì»¨í…Œì´ë„ˆ ëŒ€ì‹  ì‹¤ì œ ê°€ìš© ì˜ì—­ì„ ì§ì ‘ ê³„ì‚° (PC/ëª¨ë°”ì¼ ëŒ€ì‘)
        gameWidth = isMobile ? window.innerWidth : 500;
        gameHeight = isMobile ? window.innerHeight : window.innerHeight * 0.9;

        // [ë¬¼ë¦¬ ê°œì„ ] ë°˜ë³µ ê³„ì‚° íšŸìˆ˜ë¥¼ ëŠ˜ë ¤ ì¶©ëŒ ì •í™•ë„ í–¥ìƒ (30 -> 50)
        engine = Engine.create({ constraintIterations: 50, positionIterations: 50, velocityIterations: 50 });
        engine.world.gravity.y = 1.2; // [ë¬¼ë¦¬ ê°œì„ ] ì¤‘ë ¥ì„ ì¡°ê¸ˆ ë‚®ì¶”ì–´ ë¬µì§í•˜ê²Œ ì•ˆì°© (2.0 -> 1.2)

        render = Render.create({
            element: container,
            engine: engine,
            options: { 
                width: gameWidth, 
                height: gameHeight, 
                wireframes: false, 
                background: 'transparent',
                hasBounds: true 
            }
        });

        const bottomOffset = isMobile ? 200 : 150; 
        const groundHeight = bottomOffset + 100;
        
        // ë°”ë‹¥ ìƒì„±
        ground = Bodies.rectangle(gameWidth / 2, gameHeight + (groundHeight / 2) - (bottomOffset - 25), gameWidth, groundHeight, { 
            isStatic: true, 
            label: 'ground', 
            render: { fillStyle: '#333' } 
        });
        
        Composite.add(engine.world, [ground]);

        setupEvents();
        runner = Runner.create();    
        Runner.run(runner, engine);
        Render.run(render);
    }

    function setupEvents() {
        // [í•µì‹¬] ë§¤ í”„ë ˆì„ë§ˆë‹¤ ì¹´ë©”ë¼ë¥¼ ë¶€ë“œëŸ½ê²Œ ì´ë™ì‹œí‚¤ëŠ” ë¡œì§
        Events.on(render, 'beforeRender', () => {
            // ë¶€ë“œëŸ¬ìš´ ì´ë™ (Lerp)
            cameraY += (targetCameraY - cameraY) * 0.05;
            
            // Matter.js ë·°í¬íŠ¸(Bounds) ì´ë™
            // min.yê°€ ì¤„ì–´ë“¤ë©´ ë” ë†’ì€(ìœ„ìª½) ê³³ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
            Bounds.shift(render.bounds, {
                x: 0,
                y: cameraY
            });
        });

        Events.on(render, 'afterRender', () => {
            const context = render.context;
            const currentTime = Date.now();
            const activeStones = stones.filter(s => !s.isStatic);

            // [í•µì‹¬] ì¹´ë©”ë¼ ë³€í™˜ ì ìš© (ì›”ë“œ ì¢Œí‘œ -> í™”ë©´ ì¢Œí‘œ)
            context.save();
            context.translate(-render.bounds.min.x, -render.bounds.min.y);

            // [ë¯¸ë¦¬ë³´ê¸°] ê·¸ë¦¬ê¸°
            if (isGameStarted && !isGameOver && isPressing && activeStones.length === 0) {
                context.save();
                context.translate(currentInputPos.x, currentInputPos.y);
                context.globalAlpha = 0.6;
                // ë†“ì„ ìˆ˜ ì—†ëŠ” ìœ„ì¹˜ë©´ ë¶‰ì€ìƒ‰, ê°€ëŠ¥í•˜ë©´ ë°ì€ íšŒìƒ‰
                context.fillStyle = isValidLocation ? '#f5f5f5' : '#ff7675'; 
                
                context.beginPath();
                const vertices = nextStoneData.vertices;
                context.moveTo(vertices[0].x, vertices[0].y);
                for (let i = 1; i < vertices.length; i++) {
                    context.lineTo(vertices[i].x, vertices[i].y);
                }
                context.closePath();
                context.fill();
                
                context.fillStyle = '#333';
                context.font = 'bold 20px Arial'; context.textAlign = 'center';
                context.fillText('â—â—¡â—', 0, 5); 

                // [ìˆ˜ì •] ğŸ‘† ì—ëª¨ì§€ë¥¼ ëŒì˜ ì˜¤ë¥¸ìª½ ëì— ìœ„ì¹˜ì‹œí‚´
                context.globalAlpha = 1.0;
                context.font = '35px Arial';
                // ëŒì˜ ë„ˆë¹„(nextStoneData.w)ì˜ ì ˆë°˜ ì§€ì  ê·¼ì²˜ë¡œ ì´ë™
                context.fillText('ğŸ‘†', nextStoneData.w / 2, 20); 
                context.restore();
            }

            // [ë°”ë‹¥/ëŒ] ê·¸ë¦¬ê¸°
            const allBodies = [ground, ...stones];
            allBodies.forEach(body => {
                if (!body) return;
                const { x, y } = body.position;
                
                // ê¸°ë°˜ì•”ì´ ë°”ë‹¥ ê·¼ì²˜ì— ì˜¤ë©´ ì™„ë²½í•˜ê²Œ ê³ ì • (Static)
                const isMobile = window.innerWidth <= 500;
                const stopOffset = isMobile ? 200 : 150; 
                const stopY = gameHeight - stopOffset; 
                
                if (body.label === 'baseStone' && !body.isStatic && y >= stopY) {
                    Body.setStatic(body, true);
                    Body.setPosition(body, { x: gameWidth / 2, y: stopY });
                }

                if (!body.isStatic) {
                    const isStable = body.speed < 0.3 && body.angularSpeed < 0.05;
                    if (isStable) {
                        if (!body.stableStartTime) body.stableStartTime = currentTime;
                        else if (currentTime - body.stableStartTime > 600) Body.setStatic(body, true);
                    } else body.stableStartTime = null;
                }

                // [ì¶”ê°€] ì‹¤ì œ ëŒ ëª¨ì–‘ ì§ì ‘ ê·¸ë¦¬ê¸° (ì˜¤ëª©í•œ ëª¨ì–‘ ëŒ€ì‘)
                context.save();
                
                if (body.render.fillStyle === 'rainbow') {
                    // ì˜ë¡±í•œ ëŒ: ì‹œê°„ì— ë”°ë¼ ë³€í•˜ëŠ” ë¬´ì§€ê°œ ë¹›
                    const hue = (currentTime / 30) % 360;
                    context.fillStyle = `hsl(${hue}, 80%, 70%)`;
                    // ê´‘ì±„ íš¨ê³¼ ì¶”ê°€
                    context.shadowColor = `hsl(${hue}, 80%, 70%)`;
                    context.shadowBlur = 15;
                } else {
                    context.fillStyle = body.render.fillStyle;
                }
                
                // ì˜¤ëª©í•œ ë°”ë””ëŠ” ì—¬ëŸ¬ 'parts'ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. (parts[0]ì€ ì „ì²´ë¥¼ í¬í•¨í•˜ëŠ” ë”ë¯¸ ë°”ë””)
                const drawParts = body.parts.length > 1 ? body.parts.slice(1) : [body];
                
                drawParts.forEach(part => {
                    context.beginPath();
                    const partVertices = part.vertices;
                    // ë¬¼ë¦¬ ì—”ì§„ì˜ ì›”ë“œ ì¢Œí‘œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë˜, drawPartsë¥¼ ìˆœíšŒí•˜ë¯€ë¡œ ì •í™•íˆ ê·¸ë ¤ì§
                    context.moveTo(partVertices[0].x, partVertices[0].y);
                    for (let j = 1; j < partVertices.length; j++) {
                        context.lineTo(partVertices[j].x, partVertices[j].y);
                    }
                    context.closePath();
                    context.fill();
                });
                context.restore();

                // [ìˆ˜ì •] ë°”ë‹¥(ground)ì€ ì–´ë–¤ ê²½ìš°ì—ë„ í‘œì •ì„ ê·¸ë¦¬ì§€ ì•ŠìŒ
                if (body.label === 'ground' || body === ground) return;

                context.save();
                context.translate(x, y); 
                context.rotate(body.angle);
                
                // ëŒì˜ í‘œì • ê·¸ë¦¬ê¸°
                const fillStyle = body.render.fillStyle;
                if (fillStyle === 'rainbow') {
                    context.fillStyle = '#fff'; // ì˜ë¡±í•œ ëŒì€ í°ìƒ‰ í‘œì •
                    context.shadowBlur = 0; // í‘œì •ì—ëŠ” ê·¸ë¦¼ì ì œê±°
                } else {
                    context.fillStyle = fillStyle === '#404040' || fillStyle === '#707070' ? '#ddd' : '#333'; 
                }
                context.textAlign = 'center'; 
                context.font = 'bold 20px Arial';
                
                let emoji = body.speed < 0.3 ? 'â—â—¡â—' : 'âŠ™ï½âŠ™';
                if (body.label === 'baseStone' && body.isStatic) emoji = 'â—â—¡â—';
                
                context.fillText(emoji, 0, 5);
                context.restore();
            });

            context.restore();
        });

        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach(pair => {
                const { bodyA, bodyB } = pair;
                if ((stones.includes(bodyA) && !bodyA.isStatic) || (stones.includes(bodyB) && !bodyB.isStatic)) {
                    if (bodyA !== ground && bodyB !== ground && bodyA.label !== 'baseStone' && bodyB.label !== 'baseStone') {
                        stones.forEach(s => { if (s.isStatic && s.label !== 'baseStone') Body.setStatic(s, false); });
                    }
                }
                if ((bodyA === ground || bodyB === ground) && !isGameOver) {
                    if (bodyA.label === 'stone' || bodyB.label === 'stone') gameOver();
                }
            });
        });
    }

    // [ì…ë ¥ í•¸ë“¤ëŸ¬] ì¹´ë©”ë¼ ìœ„ì¹˜(cameraY)ë¥¼ ê³ ë ¤í•˜ì—¬ ì¢Œí‘œ ê³„ì‚°
    const handleMove = (e) => {
        if (!isPressing) return;
        const rect = document.getElementById('game-page').getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        // [ìˆ˜ì •] ê°„ì ‘ ì¡°ì‘: í„°ì¹˜ ì‹œì‘ì ìœ¼ë¡œë¶€í„°ì˜ ì´ë™ ê±°ë¦¬ë§Œí¼ ëŒì„ ì´ë™ì‹œí‚´ (1:1 ë§¤í•‘)
        const deltaX = clientX - initialTouchX;
        const deltaY = clientY - initialTouchY; // ìƒí•˜ ì´ë™ ê±°ë¦¬ ê³„ì‚°
        
        currentInputPos.x = initialStoneX + deltaX;
        currentInputPos.y = initialStoneY + deltaY; // ìƒí•˜ ìœ„ì¹˜ ì—…ë°ì´íŠ¸

        // í™”ë©´ ê²½ê³„ ì œí•œ (ì¢Œìš°)
        if (currentInputPos.x < 50) currentInputPos.x = 50;
        if (currentInputPos.x > gameWidth - 50) currentInputPos.x = gameWidth - 50;
        
        // í™”ë©´ ê²½ê³„ ì œí•œ (ìƒí•˜ - ë„ˆë¬´ ìœ„ë‚˜ ì•„ë˜ë¡œ ê°€ì§€ ì•Šê²Œ)
        const minY = targetCameraY + 50;
        const maxY = gameHeight - 250; // ë°”ë‹¥ íšŒìƒ‰ ì˜ì—­ ì¹¨ë²” ë°©ì§€
        if (currentInputPos.y < minY) currentInputPos.y = minY;
        if (currentInputPos.y > maxY) currentInputPos.y = maxY;

        // [ì¶”ê°€] ëŒì´ ê²¹ì¹˜ëŠ”ì§€ ì²´í¬
        checkValidity();
    };

    function checkValidity() {
        if (!isPressing) return;
        
        // ë¯¸ë¦¬ë³´ê¸° ëŒì˜ ì„ì‹œ ë°”ë”” ìƒì„± (ìœ„ì¹˜ ì²´í¬ìš©)
        const tempVertices = nextStoneData.vertices.map(v => ({ x: v.x + currentInputPos.x, y: v.y + currentInputPos.y }));
        const tempBody = Bodies.fromVertices(currentInputPos.x, currentInputPos.y, [tempVertices]);
        
        if (!tempBody) {
            isValidLocation = true;
            return;
        }

        // ê¸°ì¡´ ëŒë“¤ê³¼ì˜ ì¶©ëŒ ì²´í¬
        const collisions = Matter.Query.region(stones, tempBody.bounds);
        
        // Boundsë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•˜ë¯€ë¡œ ì‹¤ì œ ì •ì  ê²¹ì¹¨ í™•ì¸
        let overlapped = false;
        for (let other of collisions) {
            if (Matter.SAT.collides(tempBody, other).collided) {
                overlapped = true;
                break;
            }
        }
        
        isValidLocation = !overlapped;
    }

    const handleStart = (e) => {
        if (!isGameStarted || isGameOver) return;
        // ê²Œì„ ì‹œì‘ ì „ì˜ ì”ì—¬ í„°ì¹˜/í´ë¦­ ë°©ì§€
        if (e.target.id === 'start-overlay') return;
        
        const rect = document.getElementById('game-page').getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        // [ì¶”ê°€] ì†Œì› ë¹Œê¸° ë²„íŠ¼ ì˜ì—­ ë³´í˜¸: ë²„íŠ¼ ê·¼ì²˜ í„°ì¹˜ ì‹œ ëŒ ìƒì„± ë°©ì§€
        const wishBtn = document.getElementById('wish-btn');
        const wishRect = wishBtn.getBoundingClientRect();
        // ë²„íŠ¼ ì£¼ë³€ 20px ì—¬ìœ  ê³µê°„ í¬í•¨ ì²´í¬
        if (clientX > wishRect.left - 20 && clientX < wishRect.right + 20 &&
            clientY > wishRect.top - 20 && clientY < wishRect.bottom + 20) {
            return;
        }
        
        const activeStones = stones.filter(s => !s.isStatic);
        if (activeStones.length === 0) {
            isPressing = true;
            // [ìˆ˜ì •] í„°ì¹˜ ì‹œì‘ ì‹œì˜ ìœ„ì¹˜ ì €ì¥ (ìƒí•˜ì¢Œìš° ê°„ì ‘ ì¡°ì‘ìš©)
            initialTouchX = clientX;
            initialTouchY = clientY;
            initialStoneX = currentInputPos.x;
            initialStoneY = currentInputPos.y;
            handleMove(e);
        }
    };

    const handleEnd = () => {
        if (isPressing && !isGameOver) {
            isPressing = false;
            if (isValidLocation) {
                dropStone();
            }
        }
    };

    const gamePage = document.getElementById('game-page');
    gamePage.addEventListener('mousemove', handleMove);
    gamePage.addEventListener('mousedown', handleStart);
    // window ëŒ€ì‹  wrapperë‚˜ ì»¨í…Œì´ë„ˆì—ì„œ ì²˜ë¦¬í•˜ì—¬ ì´ë²¤íŠ¸ í˜¼ì„  ë°©ì§€
    document.getElementById('game-wrapper').addEventListener('mouseup', handleEnd);
    
    gamePage.addEventListener('touchstart', (e) => { 
        if (isGameStarted) {
            e.preventDefault(); 
            handleStart(e); 
        }
    }, {passive: false});
    gamePage.addEventListener('touchmove', (e) => { 
        if (isGameStarted) {
            e.preventDefault(); 
            handleMove(e);  
        }
    }, {passive: false});
    gamePage.addEventListener('touchend', (e) => { 
        if (isGameStarted) {
            e.preventDefault(); 
            handleEnd(); 
        }
    }, {passive: false});

    function dropStone() {
        const rand = Math.random();
        let color;
        if (rand < 0.24) color = '#f5f5f5';       // 24% í°ìƒ‰
        else if (rand < 0.48) color = '#b0b0b0'; // 24% ë°ì€ íšŒìƒ‰
        else if (rand < 0.72) color = '#707070'; // 24% íšŒìƒ‰
        else if (rand < 0.95) color = '#404040'; // 23% ì§„í•œ íšŒìƒ‰
        else color = 'rainbow'; // 5% í™•ë¥  ì˜ë¡±í•œ ëŒ
        
        // 1. Matter.js ì „ìš© Vertices ê°ì²´ ìƒì„± ë° ì •ì œ
        let vertices = Matter.Vertices.create(nextStoneData.vertices);
        
        // 2. ì˜¤ëª©í•œ ë„í˜•ì„ ìœ„í•œ Body ìƒì„±
        const stone = Bodies.fromVertices(currentInputPos.x, currentInputPos.y, [vertices], {
            friction: 10.0, 
            frictionStatic: 1000.0, 
            restitution: 0, 
            density: 100, // [ë¬¼ë¦¬ ê°œì„ ] ë°€ë„ë¥¼ ë†’ì—¬ ë¬µì§í•œ ë¬´ê²Œê° ë¶€ì—¬ (50 -> 100)
            label: 'stone',
            render: { 
                fillStyle: color,
                visible: false 
            }
        }, true, 0.01, 10, 0.01);

        if (!stone) return; // ìƒì„± ì‹¤íŒ¨ ì‹œ (ë“œë¬¼ê²Œ ë°œìƒ)

        stones.push(stone);
        Composite.add(engine.world, stone);
        stoneCount++;
        
        const currentFloor = stoneCount + 1;
        document.getElementById('count').textContent = currentFloor;
        
        updateEnvironment(currentFloor);
        prepareNextStone();
    }

    function gameOver() {
        if (isGameOver) return;
        isGameOver = true; 
        isPressing = false;
        
        setTimeout(() => {
            alert("ëŒíƒ‘ì´ ë¬´ë„ˆì¡ŒìŠµë‹ˆë‹¤! ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”.");
            resetGame();
        }, 800);
    }

    function resetGame() {
        // 1. ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸°í™”
        isGameOver = false;
        isGameStarted = false;
        stoneCount = 0;
        document.getElementById('count').textContent = "1";
        
        // 2. ë¬¼ë¦¬ ì—”ì§„ ì›”ë“œ ì´ˆê¸°í™”
        const allStones = [...stones];
        stones = [];
        allStones.forEach(s => Composite.remove(engine.world, s));
        
        // 3. UI ì´ˆê¸°í™”
        const overlay = document.getElementById('start-overlay');
        if (overlay) {
            overlay.style.display = 'flex';
            overlay.style.pointerEvents = 'auto';
        }
        
        updateEnvironment(1);
    }
</script>
</body>
</html>